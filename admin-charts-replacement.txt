// REPLACEMENT FOR initializeRecordsSummaryCharts() function in admin.js
// Replace the entire function from line 2640 to line 3260 with this code:

function initializeRecordsSummaryCharts() {
    if (typeof ApexCharts === 'undefined') {
        console.log('ApexCharts not loaded, retrying...');
        setTimeout(initializeRecordsSummaryCharts, 100);
        return;
    }
    
    console.log('Initializing summary charts with ApexCharts');
    
    // Destroy existing charts if they exist
    if (recordsSummaryChart) {
        try {
            recordsSummaryChart.destroy();
        } catch (e) {}
        recordsSummaryChart = null;
    }
    if (sizeDistributionSummaryChart) {
        try {
            sizeDistributionSummaryChart.destroy();
        } catch (e) {}
        sizeDistributionSummaryChart = null;
    }
    if (operatorActivitySummaryChart) {
        try {
            operatorActivitySummaryChart.destroy();
        } catch (e) {}
        operatorActivitySummaryChart = null;
    }
    if (avgSizeTrendSummaryChart) {
        try {
            avgSizeTrendSummaryChart.destroy();
        } catch (e) {}
        avgSizeTrendSummaryChart = null;
    }
    
    const allRecords = JSON.parse(localStorage.getItem('pelletRecords') || '[]');
    const allSessions = JSON.parse(localStorage.getItem('measurementSessions') || '[]');
    const allUsers = JSON.parse(localStorage.getItem('allUsers') || '[]');
    const operators = allUsers.filter(u => u.role === 'user');
    
    // Records Over Time Chart (ApexCharts - Area)
    const recordsCtx = document.getElementById('recordsSummaryChart');
    if (recordsCtx) {
        const last7Days = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            last7Days.push(date.toISOString().split('T')[0]);
        }
        
        const recordsByDate = last7Days.map(date => {
            return allRecords.filter(r => {
                const recordDate = new Date(r.timestamp).toISOString().split('T')[0];
                return recordDate === date;
            }).length;
        });
        
        const dateLabels = last7Days.map(d => {
            const date = new Date(d);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        
        const options = {
            series: [{
                name: 'Records',
                data: recordsByDate
            }],
            chart: {
                type: 'area',
                height: 280,
                fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: false,
                        zoom: false,
                        zoomin: false,
                        zoomout: false,
                        pan: false,
                        reset: false
                    }
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800
                }
            },
            colors: ['#2FA76E'],
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            fill: {
                type: 'gradient',
                gradient: {
                    opacityFrom: 0.7,
                    opacityTo: 0.15,
                    stops: [0, 90, 100]
                }
            },
            markers: {
                size: 5,
                strokeWidth: 2,
                strokeColors: '#ffffff',
                colors: ['#2FA76E'],
                hover: {
                    size: 7
                }
            },
            xaxis: {
                categories: dateLabels,
                title: {
                    text: 'Date',
                    style: {
                        fontSize: '13px',
                        fontWeight: 600,
                        color: '#6B7280'
                    }
                },
                labels: {
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: '#6B7280'
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Number of Records',
                    style: {
                        fontSize: '13px',
                        fontWeight: 600,
                        color: '#6B7280'
                    }
                },
                labels: {
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: '#6B7280'
                    }
                }
            },
            tooltip: {
                theme: 'dark',
                y: {
                    formatter: function(value) {
                        return value + ' records';
                    }
                }
            },
            grid: {
                borderColor: '#e5e7eb',
                strokeDashArray: 0,
                xaxis: {
                    lines: {
                        show: false
                    }
                },
                yaxis: {
                    lines: {
                        show: true
                    }
                }
            }
        };
        
        recordsSummaryChart = new ApexCharts(recordsCtx, options);
        recordsSummaryChart.render();
        console.log('Records summary chart rendered');
    }
    
    // Size Distribution Chart (ApexCharts - Bar)
    const sizeCtx = document.getElementById('sizeDistributionSummaryChart');
    if (sizeCtx) {
        const bins = [0, 2, 3, 4, 5, 6, 7, 8, 10, 12, 15];
        const binCounts = new Array(bins.length - 1).fill(0);
        
        allRecords.forEach(record => {
            const size = parseFloat(record.avgSize || 0);
            if (size > 0) {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (size >= bins[i] && size < bins[i + 1]) {
                        binCounts[i]++;
                        break;
                    }
                }
            }
        });
        
        const binLabels = bins.slice(0, -1).map((b, i) => `${b}-${bins[i + 1]}`);
        
        const options = {
            series: [{
                name: 'Number of Pellets',
                data: binCounts
            }],
            chart: {
                type: 'bar',
                height: 280,
                fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: false,
                        zoom: false,
                        zoomin: false,
                        zoomout: false,
                        pan: false,
                        reset: false
                    }
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800
                }
            },
            plotOptions: {
                bar: {
                    borderRadius: 8,
                    columnWidth: '80%',
                    distributed: false,
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            colors: ['#4ECDC4'],
            dataLabels: {
                enabled: false
            },
            xaxis: {
                categories: binLabels,
                title: {
                    text: 'Diameter Size Range (mm)',
                    style: {
                        fontSize: '13px',
                        fontWeight: 600,
                        color: '#6B7280'
                    }
                },
                labels: {
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: '#6B7280'
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Number of Records',
                    style: {
                        fontSize: '13px',
                        fontWeight: 600,
                        color: '#6B7280'
                    }
                },
                labels: {
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: '#6B7280'
                    }
                }
            },
            tooltip: {
                theme: 'dark',
                x: {
                    formatter: function(value) {
                        return 'Size Range: ' + value + ' mm';
                    }
                },
                y: {
                    formatter: function(value) {
                        return value + ' pellets';
                    }
                }
            },
            grid: {
                borderColor: '#e5e7eb',
                strokeDashArray: 0,
                xaxis: {
                    lines: {
                        show: false
                    }
                },
                yaxis: {
                    lines: {
                        show: true
                    }
                }
            }
        };
        
        sizeDistributionSummaryChart = new ApexCharts(sizeCtx, options);
        sizeDistributionSummaryChart.render();
        console.log('Size distribution summary chart rendered');
    }
    
    // Operator Activity Chart (ApexCharts - Horizontal Bar)
    const activityCtx = document.getElementById('operatorActivitySummaryChart');
    if (activityCtx) {
        const operatorActivity = {};
        allSessions.forEach(session => {
            const operator = session.operator || 'Unknown';
            if (!operatorActivity[operator]) {
                operatorActivity[operator] = 0;
            }
            operatorActivity[operator]++;
        });
        
        const sortedOperators = Object.entries(operatorActivity)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        
        const operatorLabels = sortedOperators.map(o => {
            const label = o[0];
            return label.length > 20 ? label.substring(0, 20) + '...' : label;
        });
        const operatorData = sortedOperators.map(o => o[1]);
        const colorPalette = ['#2FA76E', '#FF6B6B', '#4ECDC4', '#FFE66D', '#95E1D3', '#F38181', '#8b5cf6', '#ec4899', '#14b8a6', '#a855f7'];
        
        const options = {
            series: [{
                name: 'Sessions',
                data: operatorData
            }],
            chart: {
                type: 'bar',
                height: 280,
                fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: false,
                        zoom: false,
                        zoomin: false,
                        zoomout: false,
                        pan: false,
                        reset: false
                    }
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800
                }
            },
            plotOptions: {
                bar: {
                    borderRadius: 8,
                    horizontal: true,
                    distributed: true,
                    barHeight: '80%',
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            colors: colorPalette,
            dataLabels: {
                enabled: false
            },
            xaxis: {
                categories: operatorLabels,
                title: {
                    text: 'Number of Sessions',
                    style: {
                        fontSize: '13px',
                        fontWeight: 600,
                        color: '#6B7280'
                    }
                },
                labels: {
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: '#6B7280'
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Operator',
                    style: {
                        fontSize: '13px',
                        fontWeight: 600,
                        color: '#6B7280'
                    }
                },
                labels: {
                    style: {
                        fontSize: '11px',
                        fontWeight: 600,
                        colors: '#374151'
                    }
                }
            },
            tooltip: {
                theme: 'dark',
                y: {
                    formatter: function(value) {
                        return value + ' sessions';
                    }
                }
            },
            legend: {
                show: false
            },
            grid: {
                borderColor: '#e5e7eb',
                strokeDashArray: 0,
                xaxis: {
                    lines: {
                        show: true
                    }
                },
                yaxis: {
                    lines: {
                        show: false
                    }
                }
            }
        };
        
        operatorActivitySummaryChart = new ApexCharts(activityCtx, options);
        operatorActivitySummaryChart.render();
        console.log('Operator activity summary chart rendered');
    }
    
    // Average Size Trend Chart (ApexCharts - Area)
    const avgSizeTrendCtx = document.getElementById('avgSizeTrendSummaryChart');
    if (avgSizeTrendCtx) {
        const last7Days = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            last7Days.push(date.toISOString().split('T')[0]);
        }
        
        const avgSizeByDate = last7Days.map(date => {
            const dayRecords = allRecords.filter(r => {
                const recordDate = new Date(r.timestamp).toISOString().split('T')[0];
                return recordDate === date;
            });
            
            if (dayRecords.length === 0) return null;
            
            const sizes = dayRecords
                .map(r => parseFloat(r.avgSize || 0))
                .filter(s => s > 0);
            
            if (sizes.length === 0) return null;
            
            const avg = sizes.reduce((a, b) => a + b, 0) / sizes.length;
            return parseFloat(avg.toFixed(2));
        });
        
        const dateLabels = last7Days.map(d => {
            const date = new Date(d);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        
        const options = {
            series: [{
                name: 'Average Size',
                data: avgSizeByDate
            }],
            chart: {
                type: 'area',
                height: 280,
                fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: false,
                        zoom: false,
                        zoomin: false,
                        zoomout: false,
                        pan: false,
                        reset: false
                    }
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800
                }
            },
            colors: ['#8b5cf6'],
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            fill: {
                type: 'gradient',
                gradient: {
                    opacityFrom: 0.7,
                    opacityTo: 0.15,
                    stops: [0, 90, 100]
                }
            },
            markers: {
                size: 5,
                strokeWidth: 2,
                strokeColors: '#ffffff',
                colors: ['#8b5cf6'],
                hover: {
                    size: 7
                }
            },
            xaxis: {
                categories: dateLabels,
                title: {
                    text: 'Date',
                    style: {
                        fontSize: '13px',
                        fontWeight: 600,
                        color: '#6B7280'
                    }
                },
                labels: {
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: '#6B7280'
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Diameter Size (mm)',
                    style: {
                        fontSize: '13px',
                        fontWeight: 600,
                        color: '#6B7280'
                    }
                },
                labels: {
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: '#6B7280'
                    },
                    formatter: function(value) {
                        if (value === null) return 'N/A';
                        return value.toFixed(1);
                    }
                }
            },
            tooltip: {
                theme: 'dark',
                y: {
                    formatter: function(value) {
                        if (value === null) return 'No data';
                        return 'Average Size: ' + value.toFixed(2) + ' mm';
                    }
                }
            },
            grid: {
                borderColor: '#e5e7eb',
                strokeDashArray: 0,
                xaxis: {
                    lines: {
                        show: false
                    }
                },
                yaxis: {
                    lines: {
                        show: true
                    }
                }
            }
        };
        
        avgSizeTrendSummaryChart = new ApexCharts(avgSizeTrendCtx, options);
        avgSizeTrendSummaryChart.render();
        console.log('Average size trend summary chart rendered');
    }
}
