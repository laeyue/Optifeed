# User Deletion - Complete Data Wipe

## Overview
When a user is deleted, **ALL associated data is automatically wiped** from the database due to CASCADE DELETE foreign key constraints.

## Current Implementation

### Hard Delete (Not Soft Delete)
The user deletion endpoint performs a **hard DELETE** operation, which triggers CASCADE deletes on all related tables.

**Endpoint:** `DELETE /api/admin/users/:id`

## Data That Gets Automatically Deleted

### 1. **Sensors** (CASCADE)
- All sensors owned by the user (`sensors.user_id` and `sensors.username`)
- **Cascades to:** `sensor_readings` (all readings from deleted sensors)

### 2. **Sensor Readings** (CASCADE via Sensors)
- All sensor readings from sensors owned by the deleted user
- Automatically deleted when parent sensor is deleted

### 3. **Measurement Sessions** (CASCADE)
- All measurement sessions created by the user (`measurement_sessions.user_id` and `measurement_sessions.operator`)
- **Cascades to:** `pellet_records` (all records in deleted sessions)

### 4. **Pellet Records** (CASCADE)
- All pellet records created by the user (`pellet_records.user_id` and `pellet_records.operator`)
- All pellet records in sessions owned by the user

### 5. **Reports** (CASCADE)
- All reports generated by the user (`reports.user_id` and `reports.operator`)

### 6. **User Preferences** (CASCADE)
- User's personal preferences and settings (`user_preferences.user_id`)

## Data That Is Preserved (Set to NULL)

### 1. **Locations** (SET NULL)
- Locations created by the user (`locations.created_by`)
- The location itself is preserved, but `created_by` is set to NULL
- **Reason:** Locations are shared resources, should not be deleted

### 2. **Audit Log** (SET NULL)
- Audit log entries referencing the user (`audit_log.user_id`)
- The audit entries are preserved, but `user_id` is set to NULL
- **Reason:** Audit logs are required for compliance and security

### 3. **Sensor Status History** (SET NULL)
- Status change history where user changed sensor status (`sensor_status_history.changed_by`)
- The history entries are preserved, but `changed_by` is set to NULL
- **Reason:** Historical tracking is important

## Database Schema CASCADE Settings

### Tables with CASCADE DELETE:
```sql
-- Sensors
sensors.username REFERENCES users(username) ON DELETE CASCADE
sensors.user_id REFERENCES users(id) ON DELETE CASCADE

-- Sensor Readings (via sensors)
sensor_readings.sensor_id REFERENCES sensors(id) ON DELETE CASCADE

-- Measurement Sessions
measurement_sessions.operator REFERENCES users(username) ON DELETE CASCADE
measurement_sessions.user_id REFERENCES users(id) ON DELETE CASCADE

-- Pellet Records
pellet_records.operator REFERENCES users(username) ON DELETE CASCADE
pellet_records.user_id REFERENCES users(id) ON DELETE CASCADE
pellet_records.session_id REFERENCES measurement_sessions(id) ON DELETE CASCADE

-- Reports
reports.operator REFERENCES users(username) ON DELETE CASCADE
reports.user_id REFERENCES users(id) ON DELETE CASCADE

-- User Preferences
user_preferences.user_id REFERENCES users(id) ON DELETE CASCADE
```

### Tables with SET NULL (Preserved):
```sql
-- Locations
locations.created_by REFERENCES users(id) ON DELETE SET NULL

-- Audit Log
audit_log.user_id REFERENCES users(id) ON DELETE SET NULL

-- Sensor Status History
sensor_status_history.changed_by REFERENCES users(id) ON DELETE SET NULL
```

## Deletion Process

1. **Validation**
   - Check if user exists
   - Prevent deleting own account
   - Require admin role

2. **Audit Logging**
   - Log the deletion action BEFORE deleting the user
   - This ensures we have a record of who deleted what

3. **Hard Delete**
   - Execute `DELETE FROM users WHERE id = $1`
   - PostgreSQL automatically triggers CASCADE deletes on all related tables

4. **Response**
   - Returns success message with details of what was deleted

## Example Deletion Flow

When user ID 5 is deleted:

1. **User record** → Deleted
2. **Sensors (3 sensors)** → Deleted
   - **Sensor Readings (500 readings)** → Deleted (cascaded)
3. **Measurement Sessions (10 sessions)** → Deleted
   - **Pellet Records (150 records)** → Deleted (cascaded)
4. **Pellet Records (20 standalone records)** → Deleted
5. **Reports (5 reports)** → Deleted
6. **User Preferences** → Deleted
7. **Locations (2 locations created by user)** → `created_by` set to NULL (preserved)
8. **Audit Log (50 entries)** → `user_id` set to NULL (preserved)

## Security Considerations

1. **Cannot Delete Own Account**
   - Users cannot delete themselves
   - Prevents accidental account loss

2. **Admin Only**
   - Only admins can delete users
   - Protected by `requireAdmin` middleware

3. **Audit Trail**
   - All deletions are logged in `audit_log`
   - Even after user deletion, we know who performed the action

## Testing

To test user deletion:

1. Create a test user
2. Create some data for that user:
   - Sensors
   - Sessions
   - Records
   - Reports
3. Delete the user
4. Verify all data is removed:
   ```sql
   SELECT COUNT(*) FROM sensors WHERE user_id = <deleted_user_id>; -- Should be 0
   SELECT COUNT(*) FROM measurement_sessions WHERE user_id = <deleted_user_id>; -- Should be 0
   SELECT COUNT(*) FROM pellet_records WHERE user_id = <deleted_user_id>; -- Should be 0
   SELECT COUNT(*) FROM reports WHERE user_id = <deleted_user_id>; -- Should be 0
   ```

## Important Notes

⚠️ **WARNING:** User deletion is **irreversible**. All data is permanently deleted.

✅ **Safe to Delete:** The database constraints ensure data integrity - no orphaned records will remain.

✅ **Compliance:** Audit logs are preserved (with user_id set to NULL) for compliance purposes.

✅ **Shared Resources:** Locations are preserved (with created_by set to NULL) as they are shared resources.



